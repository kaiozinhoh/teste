#!/bin/bash

# Caminhos dos arquivos de buffer, temporários e de saída
TEMP_VIDEO="/home/pi/video_temp.mp4"               # Arquivo temporário de gravação contínua
VIDEO_FINAL="/home/pi/video_final.mp4"             # Clip final com os últimos 20 segundos
LOG_DIR="/home/pi/"                                # Diretório de logs

# Caminho completo para o FFmpeg
FFMPEG_PATH="/usr/bin/ffmpeg"

# Função para salvar os últimos 20 segundos do arquivo temporário
save_last_20_seconds() {
    # Verifica se o arquivo temporário existe e não está vazio
    if [ -f "$TEMP_VIDEO" ] && [ -s "$TEMP_VIDEO" ]; then
        # Obtém a duração total do arquivo temporário
        DURATION=$(ffmpeg -i $TEMP_VIDEO 2>&1 | grep "Duration" | awk '{print $2}' | tr -d ,)
        DURATION_SECONDS=$(echo $DURATION | awk -F: '{print ($1 * 3600) + ($2 * 60) + $3}')

        # Calcula o ponto de corte para os últimos 20 segundos
        START_TIME=$(($DURATION_SECONDS - 20))

        # Se a duração for menor que 20 segundos, ajusta o ponto de corte para 0
        if [ $START_TIME -lt 0 ]; then
            START_TIME=0
        fi

        # Corta os últimos 20 segundos do vídeo
        echo "Salvando os últimos 20 segundos..."
        $FFMPEG_PATH -ss $START_TIME -i $TEMP_VIDEO -t 20 -c copy -y $VIDEO_FINAL
        echo "Clip final salvo com sucesso em $VIDEO_FINAL"
    else
        echo "Erro: Arquivo temporário não encontrado ou está vazio."
    fi
}

# Função para pausar a gravação contínua (matando o processo do FFmpeg)
pause_continuous_recording() {
    echo "Pausando gravação contínua..."
    # Aqui, você pode usar um comando para matar o processo do ffmpeg. Ajuste conforme o método de execução.
    pkill -f "ffmpeg -rtsp_transport udp -i"
    sleep 1
}

# Função para reiniciar a gravação contínua
restart_continuous_recording() {
    echo "Reiniciando gravação contínua..."
    # Você pode usar o mesmo script que foi utilizado para iniciar a gravação contínua
    ./start_continuous_recording.sh &
}

# Pausar a gravação contínua
pause_continuous_recording

# Salvar os últimos 20 segundos do vídeo
save_last_20_seconds

# Reiniciar a gravação contínua
restart_continuous_recording
